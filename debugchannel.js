/*
 * (c) 2013 DebugChannel Ltd <support@debugchannel.com>
 *
 * For the full copyright and license information, please view the LICENSE
 * file that was distributed with this source code.
 */

!function(){function a(a){for(var b="/",c="",d=0,e=a.length-1;e>d;d++)b+=a[d]+"/",c+=C(b,a[d]);return c+='<li class="active">'+a[d]+"</li>"}function b(a){return-1!==a.indexOf(".")}function c(a){G.push(d().toString()+" "+JSON.stringify(a))}function d(){return parseInt((new Date).getTime()/1e3,10)}function e(){q=d()}function f(){var a=require("fs"),b=__dirname+"/install-guid";return a.existsSync(b)||a.writeFileSync(b,g()),a.readFileSync(b).toString()}function g(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0,c="x"==a?b:3&b|8;return c.toString(16)})}function h(a){function e(){F[d()]=[process.memoryUsage(),f]}this.options=a,c("server started");var f=0;setInterval(e,6e4),app=t(),server=v.createServer(app),io=require("socket.io").listen(server),io.configure(function(){this.enable("browser client minification"),this.enable("browser client gzip"),this.set("log level",1),this.set("transports",["websocket"])}),app.use(t.favicon(__dirname+"/webapp/favicon.ico")),app.use(t.static(__dirname+"/webapp")),app.use(t.static(__dirname+"/bower_components")),app.use(t.static(__dirname+"/clients"));var g=this.options.memLimit||"1mb";app.use(t.limit(g)),app.use(function(a,b,c){a.headers["content-type"]=a.headers["content-type"]||"application/json",c()});var h=0;app.use(function(a,b,c){var d=y.format("%s %s %s %s %s",h++,a.connection.remoteAddress,a.method,a.httpVersion,a.url);console.log(d),c()}),app.use(t.bodyParser()),app.use(function(a,b,c){E[q]||(E[q]={});var d=a.connection.remoteAddress;void 0===E[q][d]&&(E[q][d]={});var e=a.url;void 0===E[q][d][e]&&(E[q][d][e]={});var f="POST"===a.method?f=a.body.handler||"__UNKNOWN__":"GET";void 0===E[q][d][e][f]&&(E[q][d][e][f]=0),E[q][d][e][f]++,c()});var o=0;app.use(function(c,d,e,f){if(!c)return f();var g;413==c.status?(g="POST size limit exceeded. Max allowed "+a.memLimit+" (so sayeth the debugchannel server). ",e.send(413,g)):(g=c.message,e.send(c.status||500,g));var h=r.compact(d.url.split("/"));if(!r.any(h,b)){var i="uberdebug."+h.join(".")+".";D.publish(i,JSON.stringify({handler:"error",args:[g,c.status,d.url],trace:[{location:"debugchannel server",fn:"errorHandler"}],info:{machineId:"debugchannel server",pid:"debugchannel server",sequenceNo:++o,generationTime:(new Date).getTime()},tags:[c.status],"transient":!0}))}}),app.set("views",__dirname+"/views"),app.set("view engine","handlebars"),app.set("view options",{layout:!1}),app.engine(".tmpl",s.handlebars),app.all("/",i),app.all("/docs",j),app.all("/qunit",k),app.options("/*",function(a,b){b.header("Access-Control-Allow-Origin","*"),b.header("Access-Control-Allow-Headers","Origin, X-Requested-With, Content-Type, Accept"),b.end("")}),app.get("/*",l),app.post("/*",m(this.options.authenticateApi)),this.numMessages=0,this.authenticateApi=function(){console.log("authenticate")},io.sockets.on("connection",n),server.listen(this.options.port),console.log("listening on port "+this.options.port),J()}function i(a,b){b.writeHead(302,{Location:"/hello/world"}),b.end()}function j(a,b){b.header("Cache-Control","no-cache, private, no-store, must-revalidate, max-stale=0, post-check=0, pre-check=0"),b.render("docs.tmpl",{})}function k(a,b){b.header("Cache-Control","no-cache, private, no-store, must-revalidate, max-stale=0, post-check=0, pre-check=0"),b.render("qunit.tmpl",{})}function l(c,d){var e=r.compact(c.route.params[0].split("/"));r.any(e,b)?d.send(404,{error:'Bad url. Url cannot contain "."'}):(d.header("Cache-Control","no-cache, private, no-store, must-revalidate, max-stale=0, post-check=0, pre-check=0"),d.render("index.tmpl",{breadcrumbs:a(e),route:JSON.stringify(e),pagetitle:"dc/"+e.join("/")}))}function m(a){return function(c,d){d.header("content-type","application/json");var e=r.compact(c.route.params[0].split("/"));if(r.any(e,b))d.send(404,{error:'Bad url. Url cannot contain "."'});else{var f=c.body.apiKey||null;a(f,e.join("/"),function(){var a="uberdebug."+e.join(".")+".";D.publish(a,JSON.stringify(c.body)),d.send(200,{status:"all good"}),d.end()},function(){d.send(401,{error:"API Key failure for this channel"})})}}}function n(a){var c=x.createClient();c.setMaxListeners(5),a.on("feedback",function(){return console.log("recieved feedback"),function(a){try{u.appendFile(__dirname+"/feedback.log",JSON.stringify(a)+"\n",function(){})}catch(b){}try{A.post({method:"POST",uri:"http://www.debugchannel.com/feedback",form:{type:a.type?a.type:"feature",message:a.message?a.message:"N/A",email:a.email||a.$email$||a.Wa||null,version:"0.0.1",timestamp:(new Date).getTime(),ipaddress:null,licensee:B.licensee}},function(){})}catch(b){}}}()),a.on("subscribe",function(d){if(d=r.compact(d),d.length&&!r.any(d,b)){var e="uberdebug."+d.join(".")+".*";c.psubscribe(e),c.on("pmessage",function(b,c,d){var e=JSON.parse(d);e.channel=c.substring(10,c.length-1).split(".").join("/"),a.emit("debug",e)})}}),a.on("disconnect",function(){c.quit()})}function o(a,b,c){c()}function p(){y.puts("starting now: "+JSON.stringify(h));new h({authenticateApi:o,memLimit:"128mb",port:1025})}var q,r=require("underscore"),s=require("consolidate"),t=require("express"),u=require("fs"),v=require("http"),w=require("moment"),x=require("redis"),y=require("util"),z=require("js-yaml"),A=require("request"),B=function(){try{var a=z.safeLoad(u.readFileSync("./serial.yml","utf8"));if(!("licensee"in a)|!("serial"in a))throw"missing fields";return a}catch(b){return console.log("error loading serial.yml"),{licensee:null,serial:null}}}(),C=function(){var a=r.template('<li><a href="<%= url %>"><%- crumbName %></a></li>');return function(b,c){return a({url:b,crumbName:c})}}(),D=(function(){r.template("Anonymous access to channel <%= channel %> is not allowed.");return function(){}}(),r.template(""),x.createClient()),E=(x.createClient(),{}),F={},G=[];setInterval(e,6e4),e();var H=g(),I=function(){var a=__dirname+"/stats";try{{u.statSync(a)}}catch(b){if("ENOENT"!==b.code)throw console.log(b),b;u.mkdir(a)}var c=a+"/debugchannel."+w().format("YYYY-MM-DD_HH:mm:ss")+".json";return function(){var a=JSON.stringify({executionGuid:H,installGuid:f(),logData:G,stats:E,totals:F});u.writeFile(c,a,function(){console.log("stats written to file "+c)})}}(),J=I;setInterval(J,6e4),p()}();